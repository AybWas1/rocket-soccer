<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Pro Soccer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #ui { position: absolute; top: 0; width: 100%; z-index: 100; background: rgba(0,0,0,0.8); padding: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        #scoreboard { position: absolute; top: 80px; width: 100%; display: flex; justify-content: center; font-size: 32px; font-weight: bold; pointer-events: none; z-index: 50; }
        .score-box { margin: 0 15px; padding: 5px 20px; border-radius: 8px; }
        .p1-s { background: #3498db; } .p2-s { background: #e74c3c; }
        
        /* Joystick Styles */
        #joystick-container { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; z-index: 200; border: 2px solid rgba(255,255,255,0.3); }
        #joystick-knob { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: rgba(255,255,255,0.5); border-radius: 50%; transition: transform 0.1s; }
        
        canvas { display: block; }
        .flipped { transform: rotate(180deg); }
        input, button { padding: 8px; border-radius: 5px; border: none; }
        button { background: #2ecc71; color: white; cursor: pointer; font-weight: bold; }
        #copy-btn { background: #3498db; }
    </style>
</head>
<body>

<div id="ui">
    <span>ID: <b id="my-id">...</b></span>
    <button id="copy-btn" onclick="copyId()">ID Kopyala</button>
    <input type="text" id="remote-id" placeholder="Rakip ID">
    <button onclick="connectToPeer()">Bağlan</button>
    <div id="status">Bekleniyor...</div>
</div>

<div id="scoreboard">
    <div class="score-box p1-s" id="s1">0</div>
    <div class="score-box p2-s" id="s2">0</div>
</div>

<div id="joystick-container">
    <div id="joystick-knob"></div>
</div>

<script>
const { Engine, Render, Runner, Bodies, Composite, Body, Events, Vector } = Matter;

let isHost = true;
let conn;
let scores = { p1: 0, p2: 0 };
const w = window.innerWidth;
const h = window.innerHeight;

const engine = Engine.create();
engine.world.gravity.y = 0;

const render = Render.create({
    element: document.body,
    engine: engine,
    options: { width: w, height: h, wireframes: false, background: '#27ae60' }
});

// Saha ve Kaleler
const goalWidth = w * 0.5;
const wallOpts = { isStatic: true, render: { fillStyle: '#1e8449' } };
const goalOpts = { isStatic: true, render: { fillStyle: '#fff', opacity: 0.5 } };

const walls = [
    // Yan Duvarlar
    Bodies.rectangle(0, h/2, 20, h, wallOpts),
    Bodies.rectangle(w, h/2, 20, h, wallOpts),
    // Kale yanlarındaki duvarlar (Üst)
    Bodies.rectangle((w - goalWidth)/4, 10, (w - goalWidth)/2, 20, wallOpts),
    Bodies.rectangle(w - (w - goalWidth)/4, 10, (w - goalWidth)/2, 20, wallOpts),
    // Kale yanlarındaki duvarlar (Alt)
    Bodies.rectangle((w - goalWidth)/4, h-10, (w - goalWidth)/2, 20, wallOpts),
    Bodies.rectangle(w - (w - goalWidth)/4, h-10, (w - goalWidth)/2, 20, wallOpts)
];

// Görsel Kaleler
const goals = [
    Bodies.rectangle(w/2, 5, goalWidth, 10, { isStatic: true, isSensor: true, render: { fillStyle: '#e74c3c' } }),
    Bodies.rectangle(w/2, h-5, goalWidth, 10, { isStatic: true, isSensor: true, render: { fillStyle: '#3498db' } })
];

const ball = Bodies.circle(w/2, h/2, 15, { 
    restitution: 1, frictionAir: 0.015, render: { fillStyle: '#fff' }, label: 'ball' 
});

const p1 = Bodies.circle(w/2, h - 120, 25, { frictionAir: 0.1, render: { fillStyle: '#3498db' } });
const p2 = Bodies.circle(w/2, 120, 25, { frictionAir: 0.1, render: { fillStyle: '#e74c3c' } });

Composite.add(engine.world, [...walls, ...goals, ball, p1, p2]);
Render.run(render);
Runner.run(Runner.create(), engine);

// --- JOYSTICK LOGIC ---
const knob = document.getElementById('joystick-knob');
const container = document.getElementById('joystick-container');
let moveDir = { x: 0, y: 0 };

container.addEventListener('touchstart', handleJoystick);
container.addEventListener('touchmove', handleJoystick);
container.addEventListener('touchend', () => {
    knob.style.transform = `translate(0px, 0px)`;
    moveDir = { x: 0, y: 0 };
});

function handleJoystick(e) {
    const touch = e.touches[0];
    const rect = container.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    let dx = touch.clientX - centerX;
    let dy = touch.clientY - centerY;
    const distance = Math.min(60, Math.sqrt(dx*dx + dy*dy));
    const angle = Math.atan2(dy, dx);
    
    const moveX = Math.cos(angle) * distance;
    const moveY = Math.sin(angle) * distance;
    
    knob.style.transform = `translate(${moveX}px, ${moveY}px)`;
    moveDir = { x: Math.cos(angle) * (distance/60), y: Math.sin(angle) * (distance/60) };
}

// --- UTILS ---
function copyId() {
    const id = document.getElementById('my-id').innerText;
    navigator.clipboard.writeText(id);
    alert("ID Kopyalandı!");
}

function checkGoals() {
    if (!isHost) return;
    if (ball.position.y < 20 && Math.abs(ball.position.x - w/2) < goalWidth/2) {
        scores.p1++; resetMatch();
    } else if (ball.position.y > h - 20 && Math.abs(ball.position.x - w/2) < goalWidth/2) {
        scores.p2++; resetMatch();
    }
}

function resetMatch() {
    Body.setPosition(ball, { x: w/2, y: h/2 });
    Body.setVelocity(ball, { x: 0, y: 0 });
    document.getElementById('s1').innerText = scores.p1;
    document.getElementById('s2').innerText = scores.p2;
}

// --- NETWORK (PEERJS) ---
const peer = new Peer();
peer.on('open', (id) => document.getElementById('my-id').innerText = id);
peer.on('connection', (c) => { 
    conn = c; isHost = true; setupNetwork();
    document.getElementById('status').innerText = "Rakip Bağlandı!";
});

function connectToPeer() {
    const rId = document.getElementById('remote-id').value;
    conn = peer.connect(rId);
    isHost = false;
    document.querySelector('canvas').classList.add('flipped');
    document.getElementById('scoreboard').classList.add('flipped');
    setupNetwork();
}

function setupNetwork() {
    conn.on('data', (data) => {
        if (isHost) { if (data.p2v) Body.applyForce(p2, p2.position, data.p2v); }
        else {
            if (data.b) Body.setPosition(ball, data.b);
            if (data.p1) Body.setPosition(p1, data.p1);
            if (data.p2) Body.setPosition(p2, data.p2);
            if (data.s) {
                document.getElementById('s1').innerText = data.s.p1;
                document.getElementById('s2').innerText = data.s.p2;
            }
        }
    });
}

Events.on(engine, 'beforeUpdate', () => {
    const player = isHost ? p1 : p2;
    const forceMag = 0.005;
    
    // Joystick Hareket Uygula
    if (moveDir.x !== 0 || moveDir.y !== 0) {
        Body.applyForce(player, player.position, { x: moveDir.x * forceMag, y: moveDir.y * forceMag });
    }

    if (isHost) {
        checkGoals();
        if (conn?.open) conn.send({ b: ball.position, p1: p1.position, p2: p2.position, s: scores });
    } else {
        if (conn?.open) conn.send({ p2v: { x: moveDir.x * forceMag, y: moveDir.y * forceMag } });
    }
});
</script>
</body>
</html>
